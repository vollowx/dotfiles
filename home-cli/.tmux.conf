set -gq default-terminal 'tmux-256color'
set -gqa terminal-overrides ',*:Tc'

set -gq display-time 1024
set -gq history-limit 65536
set -gq renumber-windows on
set-hook -g window-linked 'move-window -r'

set -s escape-time 0

set -gq base-index 1
setw -g pane-base-index 1

set -gq mouse on

bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-selection-no-clear
bind -T copy-mode-vi MouseDown1Pane send -X clear-selection
bind -T copy-mode-vi DoubleClick1Pane send -X select-word

set -gq status-style                 fg=white
set -gq window-status-activity-style fg=default
set -gq window-status-bell-style     fg=black,bg=magenta
set -gq window-status-current-style  fg=black,bg=yellow
set -gq mode-style                   fg=black,bg=white

set -gq pane-border-style fg=brightblack
set -gq pane-active-border-style fg=white

set -gq copy-mode-match-style fg=black,bg=blue
set -gq copy-mode-current-match-style fg=black,bg=yellow

setw -g window-status-current-format ' #{?window_zoomed_flag,#[italics],}#{window_name} '
setw -g window-status-format ' #{?window_zoomed_flag,#[italics],}#{window_name} '

set -gq bell-action none
set -gq focus-events on
set -gq monitor-activity on
set -gq visual-activity off
set -gq status-interval 1
set -gq automatic-rename on
set -gq automatic-rename-format \
    '#{?#{==:#{pane_current_path},#{HOME}},~,#{b:pane_current_path}}'

set -gq status off
set -gq status-position top
set -gq status-left-length 64
set -gq status-right-length 64
set -gq status-left '#[fg=black,bg=yellow]#{?#{==:#{key-table},none}, PASSTHROUGH ,}\
#[bg=default]#{?#{==:#{key-table},none}, ,}\
#[fg=black,bg=yellow]#{?pane_input_off, LOCKED ,}'
set -gq status-right "#{?pane_in_mode,#[fg=black#,bg=grey],#[fg=black#,bg=brightblue]} #S #[bg=default]"
# Tmux don't have 'absolute-centre' option value until v3.2
if "ver=\$(tmux -V | grep -o '[[:digit:].]\\+');  \
        ver_major=\$(echo \$ver | cut -d . -f1); \
        ver_minor=\$(echo \$ver | cut -d . -f2); \
        [ \$ver_major -gt 3 ] ||                 \
        [ \$ver_major -eq 3 -a \$ver_minor -ge 2 ]" \
    { set -gq status-justify absolute-centre }

%hidden set_status="if -F '#{==:#{session_windows},1}' \
    'set status off' \
    'set status on'"
set-hook -ga window-linked          "$set_status"

set-hook -g  window-unlinked        "$set_status"
set-hook -g  client-session-changed "$set_status"

set -gq pane-border-format " #P #T "

# Use fzf to select tmux windows
# Source: https://stackoverflow.com/a/38160854
%hidden list_windows="tmux list-windows -aF '##S:##I (##W)' | \
    sed -e 's/^\\\\([^:]*\\\\):/\\\\x1b[34m\\\\1\\\\x1b[0m:/' \
        -e 's/:\\\\([0-9]\\\\+\\\\) /:\\\\x1b[32m\\\\1\\\\x1b[0m /' \
        -e 's/(\\\\(.*\\\\))\$/(\\\\x1b[33m\\\\1\\\\x1b[0m)/'"

set -s command-alias[109] fzf-find-window="run -b \"$list_windows | \
    fzf --no-preview --ansi --color hl:reverse:-1,hl+:reverse:-1 \
        --prompt 'Tmux windows> ' \
        --tmux center,border-native,\
\\\$(w=\\\$(tmux display -p '#{window_width}'); echo \\\$(( w < 64 ? w : 64 ))),\
\\\$(h=\\\$(tmux display -p '#{window_height}'); echo \\\$(( h < 16 ? h : 16 ))) \
        --bind \\\"ctrl-x:execute(echo {+} | \
            sed 's/([^()]*)//g' | \
            sed 's/\\\\s\\\\+/\\\\n/g' | \
            tac | \
            xargs -I % tmux kill-window -t %)+reload($list_windows)\\\" | \
    tail -n1 | \
    sed 's/\\s*(.*)\$//' | \
    xargs -r tmux switch -t\""

if 'fzf --version' {
    bind f fzf-find-window
    bind -n M-C-f fzf-find-window
}

# Search for URIs in current pane, open current match with Enter
set -s command-alias[110] search-backward-uri="copy-mode; \
    send -X search-backward \
    '(https?://|git@|git://|ssh://|ftp://|file:///)[[:alnum:]?=%/_.:,;~@!#\$&()*+-]+|\
[^[:blank:]]*(/|\\.)[^[:blank:]]+|\
[^[:blank:]]+(/|\\.)[^[:blank:]]*|\
#?\<[[:xdigit:]]{6,}\>'"

unbind C-b
set -g prefix C-Space
bind C-Space send-prefix
bind -n      M-C-Down {
    set key-table none
    if -F '#{==:#{status},off}' {
        display 'Keybinding passthrough ON'
    }
}
bind -T none M-C-Up {
    set -u key-table
    if -F '#{==:#{status},off}' {
        display 'Keybinding passthrough OFF'
    }
}

bind-key -T copy-mode-vi \\ search-backward-uri

set -gq mode-keys vi
set -gq status-keys emacs

%hidden is_shell="ps -o comm= -t '#{pane_tty}' | \
    tail -n1 | \
    grep -qE '((ba|da|fi|z)?sh)\$'"

%hidden smart_close="if -F '#{<=:#{window_panes},1}' \
    \"confirm kill-pane\" \
    \"if \\\"$is_shell\\\" \
    'kill-pane' \
    'confirm kill-pane'\""

bind C-r choose-buffer
bind \"  choose-buffer
bind -T copy-mode-vi \" choose-buffer

bind n   split-window -v -c '#{pane_current_path}'
bind s   split-window -v -c '#{pane_current_path}'
bind v   split-window -h -c '#{pane_current_path}'
bind C-s split-window -v -c '#{pane_current_path}'
bind C-v split-window -h -c '#{pane_current_path}'
bind C-n new-window   -a -c '#{pane_current_path}'
bind C-o confirm 'kill-pane -a'
bind o confirm 'kill-pane -a'
bind O resize-pane -Z
bind c "$smart_close"
bind N new-window -a -c "#{pane_current_path}"
bind T previous-window
bind t next-window
bind r swap-pane -D
bind R swap-pane -U
bind = select-layout tiled

bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# TUI apps that need Escape
%hidden running_tui="ps -o stat=,args= -t '#{pane_tty}' | grep -qE \
'S\\S*\\+\\s+(sudo.*\\s+)?(.*sh\s+-c\s+)?(.*python.*)?\\S*\
(n?vim?|vimdiff|emacs(client)?|lem|nano|h(eli)?x|kak|\
tmux|vifm|yazi|ranger|lazygit|h?top|gdb|fzf|nmtui|opencode|\
sudoedit|crontab|asciinema|w3m|python3?\s+-m|ssh)(\$|\\s+)'"

# Vim needs more extensive keymaps, e.g. M-h/j/k/l
%hidden running_vim="ps -o stat=,args= -t '#{pane_tty}' | grep -qE \
'S\\S*\\+\\s+(sudo.*\\s+)?(.*sh\s+-c\s+)?\\S*(n?vim?|vimdiff|ssh)(\$|\\s+)'"

bind -n M-Escape   copy-mode
bind -n C-M-Escape copy-mode
bind -n M-:   command-prompt
bind -n C-M-: command-prompt

# Smart escape -- send Escape key to underlying app if it is a TUI app, else
# enter copy mode
# Use prefix + Escape to force send Escape to underlying app
bind -n Escape if -F '#{pane_in_mode}' 'send q' { if "$running_tui" 'send Escape' 'copy-mode' }
bind Escape 'send Escape'

# Integration with TUI apps
bind -n M-h if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ] || [ \$(tmux display -p '#{pane_in_mode}') = 1 ]" 'send M-h' { if -F '#{pane_at_left}'   '' 'select-pane -L' }
bind -n M-j if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ] || [ \$(tmux display -p '#{pane_in_mode}') = 1 ]" 'send M-j' { if -F '#{pane_at_bottom}' '' 'select-pane -D' }
bind -n M-k if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ] || [ \$(tmux display -p '#{pane_in_mode}') = 1 ]" 'send M-k' { if -F '#{pane_at_top}'    '' 'select-pane -U' }
bind -n M-l if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ] || [ \$(tmux display -p '#{pane_in_mode}') = 1 ]" 'send M-l' { if -F '#{pane_at_right}'  '' 'select-pane -R' }
bind -T copy-mode-vi M-h if -F '#{pane_at_left}'   '' 'select-pane -L'
bind -T copy-mode-vi M-j if -F '#{pane_at_bottom}' '' 'select-pane -D'
bind -T copy-mode-vi M-k if -F '#{pane_at_top}'    '' 'select-pane -U'
bind -T copy-mode-vi M-l if -F '#{pane_at_right}'  '' 'select-pane -R'

bind -n M-Left  if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ]" 'send M-Left'  { if -F '#{pane_at_left}'   '' 'select-pane -L' }
bind -n M-Down  if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ]" 'send M-Down'  { if -F '#{pane_at_bottom}' '' 'select-pane -D' }
bind -n M-Up    if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ]" 'send M-Up'    { if -F '#{pane_at_top}'    '' 'select-pane -U' }
bind -n M-Right if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ]" 'send M-Right' { if -F '#{pane_at_right}'  '' 'select-pane -R' }
bind -T copy-mode-vi M-Left  if -F '#{pane_at_left}'   '' 'select-pane -L'
bind -T copy-mode-vi M-Down  if -F '#{pane_at_bottom}' '' 'select-pane -D'
bind -T copy-mode-vi M-Up    if -F '#{pane_at_top}'    '' 'select-pane -U'
bind -T copy-mode-vi M-Right if -F '#{pane_at_right}'  '' 'select-pane -R'

bind -n M-t if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ] || [ \$(tmux display -p '#{pane_in_mode}') = 1 ]" 'send M-t' 'select-pane -t 1'
bind -n M-w if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ] || [ \$(tmux display -p '#{pane_in_mode}') = 1 ]" 'send M-w' 'select-pane -t :.+'
bind -n M-W if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ] || [ \$(tmux display -p '#{pane_in_mode}') = 1 ]" 'send M-W' 'select-pane -t :.-'
bind -n M-n if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ] || [ \$(tmux display -p '#{pane_in_mode}') = 1 ]" 'send M-n' 'split-window -v -c "#{pane_current_path}"'
bind -n M-s if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ] || [ \$(tmux display -p '#{pane_in_mode}') = 1 ]" 'send M-s' 'split-window -v -c "#{pane_current_path}"'
bind -n M-v if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ] || [ \$(tmux display -p '#{pane_in_mode}') = 1 ]" 'send M-v' 'split-window -h -c "#{pane_current_path}"'
bind -n M-c if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ] || [ \$(tmux display -p '#{pane_in_mode}') = 1 ]" 'send M-c' "$smart_close"
bind -n M-q if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ] || [ \$(tmux display -p '#{pane_in_mode}') = 1 ]" 'send M-q' "$smart_close"
bind -n M-o if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ] || [ \$(tmux display -p '#{pane_in_mode}') = 1 ]" 'send M-o' "confirm 'kill-pane -a'"
bind -n M-r if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ] || [ \$(tmux display -p '#{pane_in_mode}') = 1 ]" 'send M-r' 'swap-pane -D'
bind -n M-R if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ] || [ \$(tmux display -p '#{pane_in_mode}') = 1 ]" 'send M-R' 'swap-pane -U'
bind -n M-p if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ] || [ \$(tmux display -p '#{pane_in_mode}') = 1 ]" 'send M-p' 'last-pane'
bind -n M-z if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ] || [ \$(tmux display -p '#{pane_in_mode}') = 1 ]" 'send M-z' 'resize-pane -Z'
bind -n M-= if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ]" 'send M-=' 'select-layout tiled'
bind -T copy-mode-vi M-t select-pane -t 1
bind -T copy-mode-vi M-w select-pane -t :.+
bind -T copy-mode-vi M-W select-pane -t :.-
bind -T copy-mode-vi M-n split-window -v -c '#{pane_current_path}'
bind -T copy-mode-vi M-s split-window -v -c '#{pane_current_path}'
bind -T copy-mode-vi M-v split-window -h -c '#{pane_current_path}'
bind -T copy-mode-vi M-c "$smart_close"
bind -T copy-mode-vi M-q "$smart_close"
bind -T copy-mode-vi M-o confirm 'kill-pane -a'
bind -T copy-mode-vi M-r swap-pane -D
bind -T copy-mode-vi M-R swap-pane -U
bind -T copy-mode-vi M-p last-pane
bind -T copy-mode-vi M-z resize-pane -Z
bind -T copy-mode-vi M-= select-layout tiled

bind -r < run "tmux resize-pane -x \$((\$(tmux display -p '#{pane_width}') - 2))"
bind -r , run "tmux resize-pane -x \$((\$(tmux display -p '#{pane_width}') - 2))"
bind -r > run "tmux resize-pane -x \$((\$(tmux display -p '#{pane_width}') + 2))"
bind -r . run "tmux resize-pane -x \$((\$(tmux display -p '#{pane_width}') + 2))"
bind -r - run "tmux resize-pane -y \$((\$(tmux display -p '#{pane_height}') - 2))"
bind -r + run "tmux resize-pane -y \$((\$(tmux display -p '#{pane_height}') + 2))"

bind -n M-< if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ]" 'send M-<' "run \"tmux resize-pane -x \$((\$(tmux display -p '#{pane_width}') - 2))\""
bind -n M-, if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ]" 'send M-<' "run \"tmux resize-pane -x \$((\$(tmux display -p '#{pane_width}') - 2))\""
bind -n M-> if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ]" 'send M->' "run \"tmux resize-pane -x \$((\$(tmux display -p '#{pane_width}') + 2))\""
bind -n M-. if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ]" 'send M->' "run \"tmux resize-pane -x \$((\$(tmux display -p '#{pane_width}') + 2))\""
bind -n M-- if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ]" 'send M--' "run \"tmux resize-pane -y \$((\$(tmux display -p '#{pane_height}') - 2))\""
bind -n M-+ if "$running_vim && [ \$(tmux display -p '#{pane_input_off}') = 0 ]" 'send M-+' "run \"tmux resize-pane -y \$((\$(tmux display -p '#{pane_height}') + 2))\""
bind -T copy-mode-vi M-< run "tmux resize-pane -x \$((\$(tmux display -p '#{pane_width}') - 2))"
bind -T copy-mode-vi M-, run "tmux resize-pane -x \$((\$(tmux display -p '#{pane_width}') - 2))"
bind -T copy-mode-vi M-> run "tmux resize-pane -x \$((\$(tmux display -p '#{pane_width}') + 2))"
bind -T copy-mode-vi M-. run "tmux resize-pane -x \$((\$(tmux display -p '#{pane_width}') + 2))"
bind -T copy-mode-vi M-- run "tmux resize-pane -y \$((\$(tmux display -p '#{pane_height}') - 2))"
bind -T copy-mode-vi M-+ run "tmux resize-pane -y \$((\$(tmux display -p '#{pane_height}') + 2))"

bind -n M-C-h select-pane -L
bind -n M-C-j select-pane -D
bind -n M-C-k select-pane -U
bind -n M-C-l select-pane -R
bind -n M-C-z resize-pane -Z
bind -n M-C-o resize-pane -Z
bind -n M-C-c confirm kill-pane
bind -n M-C-q confirm kill-pane
bind -n M-C-n new-window   -a -c '#{pane_current_path}'
bind -n M-C-s split-window -v -c '#{pane_current_path}'
bind -n M-C-v split-window -h -c '#{pane_current_path}'
bind -n M-C-p last-pane
bind -T copy-mode-vi M-C-z resize-pane -Z
bind -T copy-mode-vi M-C-o resize-pane -Z
bind -T copy-mode-vi M-C-c confirm kill-pane
bind -T copy-mode-vi M-C-q confirm kill-pane
bind -T copy-mode-vi M-C-n new-window   -a -c '#{pane_current_path}'
bind -T copy-mode-vi M-C-s split-window -v -c '#{pane_current_path}'
bind -T copy-mode-vi M-C-v split-window -h -c '#{pane_current_path}'
bind -T copy-mode-vi M-C-p last-pane

# Replace current session with an existing session
bind x \
  confirm -p "Attach another session and kill current session (#S)? (y/n)" \
  "if-shell \"((\$(tmux display -p '#{session_many_attached}') > 0))\" \
    choose-session \
    \"run-shell \\\"tmux choose-session \
        \\\\\\\"switch-client -t '%%'; \
            kill-session -t '\$(tmux display -p '#S')'\\\\\\\"\\\"\""

# Use M-0 to M-9 to select windows, create new window if it doesn't exist
bind -n M-0 if 'tmux select-window -t :0' '' "new-window -t :0 -c '#{pane_current_path}'"
bind -n M-1 if 'tmux select-window -t :1' '' "new-window -t :1 -c '#{pane_current_path}'"
bind -n M-2 if 'tmux select-window -t :2' '' "new-window -t :2 -c '#{pane_current_path}'"
bind -n M-3 if 'tmux select-window -t :3' '' "new-window -t :3 -c '#{pane_current_path}'"
bind -n M-4 if 'tmux select-window -t :4' '' "new-window -t :4 -c '#{pane_current_path}'"
bind -n M-5 if 'tmux select-window -t :5' '' "new-window -t :5 -c '#{pane_current_path}'"
bind -n M-6 if 'tmux select-window -t :6' '' "new-window -t :6 -c '#{pane_current_path}'"
bind -n M-7 if 'tmux select-window -t :7' '' "new-window -t :7 -c '#{pane_current_path}'"
bind -n M-8 if 'tmux select-window -t :8' '' "new-window -t :8 -c '#{pane_current_path}'"
bind -n M-9 if 'tmux select-window -t :9' '' "new-window -t :9 -c '#{pane_current_path}'"

bind 0 if 'tmux select-window -t :0' '' "new-window -t :0 -c '#{pane_current_path}'"
bind 1 if 'tmux select-window -t :1' '' "new-window -t :1 -c '#{pane_current_path}'"
bind 2 if 'tmux select-window -t :2' '' "new-window -t :2 -c '#{pane_current_path}'"
bind 3 if 'tmux select-window -t :3' '' "new-window -t :3 -c '#{pane_current_path}'"
bind 4 if 'tmux select-window -t :4' '' "new-window -t :4 -c '#{pane_current_path}'"
bind 5 if 'tmux select-window -t :5' '' "new-window -t :5 -c '#{pane_current_path}'"
bind 6 if 'tmux select-window -t :6' '' "new-window -t :6 -c '#{pane_current_path}'"
bind 7 if 'tmux select-window -t :7' '' "new-window -t :7 -c '#{pane_current_path}'"
bind 8 if 'tmux select-window -t :8' '' "new-window -t :8 -c '#{pane_current_path}'"
bind 9 if 'tmux select-window -t :9' '' "new-window -t :9 -c '#{pane_current_path}'"

bind -n M-^ select-window -t :^
bind -n M-$ select-window -t :$

bind ^ select-window -t :^
bind _ select-window -t :^
bind $ select-window -t :$

# Switch to last used session, like vim's <C-^> or <C-6>
bind    C-^   switch-client -l
bind    C-6   switch-client -l
bind -n M-C-^ switch-client -l
bind -n M-C-6 switch-client -l

# switch to last used window, like vim's g<Tab>
bind    Tab     select-window -l
bind -n M-Tab   select-window -l
bind -n M-C-Tab select-window -l

# Use popup menu to select a layout
bind Space display-menu -x C -y C \
    -T '#[align=centre]Switch Layout' \
    'Tiled'           +  { select-layout tiled } \
    'Main Horizontal' _  { select-layout main-horizontal } \
    'Main Vertical'   |  { select-layout main-vertical } \
    'Even Horizontal' \\ { select-layout even-horizontal } \
    'Even Vertical'   -  { select-layout even-vertical }
