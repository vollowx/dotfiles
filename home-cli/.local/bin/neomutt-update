#!/usr/bin/env bash
set -Eeuo pipefail

MAIL_ROOT="${MAIL_ROOT:-$HOME/Documents/Mail}"
LOCKFILE="${XDG_RUNTIME_DIR:-/run/user/$UID}/neomutt-update.lock"

# Avoid concurrent runs
exec 9>"$LOCKFILE"
flock -n 9 || exit 0

# Ensure PATH is sane when run by systemd
export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

notify() {
  if command -v notify-send >/dev/null 2>&1 && [ -n "${DBUS_SESSION_BUS_ADDRESS:-}" ]; then
    notify-send "$@"
  fi
}

if /usr/bin/mbsync -a; then
  count="$(/usr/bin/find "$MAIL_ROOT"/*/{INBOX,Junk}/new/ -type f 2>/dev/null | /usr/bin/wc -l | /usr/bin/tr -d '[:space:]' || true)"
  : "${count:=0}"
  "$HOME/.local/bin/neomutt-count-update" "$count"

  notify "Mails" "Synchronized successfully ($count new)"
  exit 0
else
  notify "Mails" "Synchronization failed"
  exit 1
fi
