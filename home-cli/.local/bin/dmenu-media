#!/usr/bin/env sh

get_mpd_info() {
  if command -v mpc >/dev/null 2>&1; then
    # Check if MPD is running and accessible
    if mpc status >/dev/null 2>&1; then
      local current_song=$(mpc current -f "%artist% - %album% - %title%")
      local status=$(mpc status | grep -E "^\[" | sed 's/\[//g' | sed 's/\].*//g')

      if [ -n "$current_song" ]; then
        printf "mpd (%s): %s\n" "$status" "$current_song"
      else
        printf "mpd (%s): No song playing\n" "$status"
      fi
    fi
  fi
}

get_playerctl_info() {
  if command -v playerctl >/dev/null 2>&1; then
    playerctl -l 2>/dev/null | while read -r player; do
      if [ -n "$player" ]; then
        # Get player status
        local status=$(playerctl -p "$player" status 2>/dev/null || echo "Unknown")

        # Get metadata
        local artist=$(playerctl -p "$player" metadata artist 2>/dev/null || echo "Unknown Artist")
        local album=$(playerctl -p "$player" metadata album 2>/dev/null || echo "")
        local title=$(playerctl -p "$player" metadata title 2>/dev/null || echo "Unknown Title")

        # Format output
        if [ -n "$album" ] && [ "$album" != "" ]; then
          printf "%s (%s): %s - %s - %s\n" "$player" "$status" "$artist" "$album" "$title"
        else
          printf "%s (%s): %s - %s\n" "$player" "$status" "$artist" "$title"
        fi
      fi
    done
  fi
}

perform_action() {
  local player_line="$1"
  local action="$2"

  local player=$(echo "$player_line" | cut -d':' -f1 | sed 's/ (.*//')

  case "$action" in
  "toggle")
    if [ "$player" = "mpd" ]; then
      mpc toggle >/dev/null 2>&1
    else
      playerctl -p "$player" play-pause >/dev/null 2>&1
    fi
    ;;
  "previous")
    if [ "$player" = "mpd" ]; then
      mpc prev >/dev/null 2>&1
    else
      playerctl -p "$player" previous >/dev/null 2>&1
    fi
    ;;
  "next")
    if [ "$player" = "mpd" ]; then
      mpc next >/dev/null 2>&1
    else
      playerctl -p "$player" next >/dev/null 2>&1
    fi
    ;;
  esac
}

get_all_players() {
  {
    get_mpd_info
    get_playerctl_info
  }
}

show_action_menu() {
  local selected_player="$1"
  local actions="toggle\nprevious\nnext"
  local action=$(printf "$actions" | dmenu "action>")

  case "$action" in
  "toggle" | "previous" | "next")
    perform_action "$selected_player" "$action"
    ;;
  "")
    return 1 # Go back to main menu
    ;;
  esac

  show_action_menu "$1"
}

main() {
  while true; do
    local players=$(get_all_players)

    if [ -z "$players" ]; then
      notify-send "No media players found"
      exit 1
    fi

    local menu_items=$(printf "%s\nrefresh" "$players")
    local selection=$(printf "$menu_items" | dmenu "media>")

    case "$selection" in
    "refresh")
      continue
      ;;
    "")
      break
      ;;
    *)
      if echo "$players" | grep -q "^$selection$"; then
        show_action_menu "$selection"
      fi
      ;;
    esac
  done
}

main "$@"
